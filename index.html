<!DOCTYPE html>
<html>
<head>

	<title>武汉疫情-交通图</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="src/leaflet.timeline.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>

		<!-- Load Mapbox GL -->
		<link rel="stylesheet" href="https://unpkg.com/mapbox-gl/dist/mapbox-gl.css"/>
		<script src="https://unpkg.com/mapbox-gl/dist/mapbox-gl.js"></script>

		<!-- Esri Leaflet and Esri Leaflet Vector -->
		<script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
		<script src="https://unpkg.com/esri-leaflet-vector/dist/esri-leaflet-vector.js"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
			font-family: Helvetica, 'Hiragino Sans GB', 'Microsoft Yahei', '微软雅黑', Arial, sans-serif;
		}
		p {
  		font-size: 12px;
			margin:0 auto;
		}
		#info{
		width: 20%;
		margin: 1%;
	}
	  #map{
		position: fixed;
		top: 0;
		left: 20%;;
		bottom: 0;
		right: 0;
		font-family: Helvetica, 'Hiragino Sans GB', 'Microsoft Yahei', '微软雅黑', Arial, sans-serif;
	}
		.leaflet-bottom.leaflet-left{
			width: 100%;
		}
		.leaflet-control-container .leaflet-timeline-controls{
			box-sizing: border-box;
			width: 100%;
			margin: 0;
			margin-bottom: 15px;
		}
}

	</style>


</head>
<body>

<div id="info">
		<h2>铁路车次疫情</h2>
		<p>数据来源：掌上高铁-铁路车次疫情实时查询；人民日报微博</p>
		<p>更新日期：2020年2月9日</p>
		<h1 id="currentDate"></h1>
		<p>当日新增</p>
		<ul id="displayed-list"></ul>
</div>

<div id='map'>
</div>


<script src="data.js" type="text/javascript"></script>

<script>

// color pallet
	var color1 ="#980000";
	var color2 = "#ff6655";
//	var color1Flight ="#a1002b";
//	var color2Flight = "#002040";


	function getColor(d) {
    return d == "火车" ? color2 :
                          color2;
}
  function getColorAnimation(d) {
	return d == "火车" ? color1 :
												color1;
}

// base map
	var map = L.map('map').setView([30, 112], 5);

	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 15,
		 minZoom: 1,
		attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
	}).addTo(map);


/*	L.esri.Vector.basemap('StreetsNight',{
			maxZoom: 14, minZoom: 5}).addTo(map);
*/

// nodes events
	// highlight for nodes
	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 10,
			fillColor: getColor(layer.feature.properties.transit),
			color:color1,
			fillOpacity: 0.9
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	var nodes;

	function resetHighlight(e) {
		nodes.resetStyle(e.target);
		info.update();
	}

	function onEachFeatureNodes(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight
		});

		var popupContent = "<p>" +
				feature.properties.name ;
		layer.bindPopup(popupContent);

	}



//edge events
	// highlight for edges
	function highlightFeatureEdge(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 3,
			color:getColorAnimation(feature.properties.transit),
			opacity: 1
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	var edges;

	function resetHighlightEdge(e) {
		edges.resetStyle(e.target);
		info.update();
	}

// mouse event
	function onEachFeatureEdges(feature, layer) {
		layer.on({
			mouseover: highlightFeatureEdge,
			mouseout: resetHighlightEdge
		});
    var dateFormatted = function(date){
			return moment((date-25569)*86400*1000+4*5000000).format("YYYY-MM-DD")}

		var popupContent = "<p>" +
				feature.properties.from + "至"+ feature.properties.to+
				"<br>"+ feature.properties.car_number + "<br>"+ dateFormatted(feature.properties.date);

		layer.bindPopup(popupContent);

		}





// edges
	edges = L.geoJSON(edges, {
		// edge style
		style:function style(feature) {
			return {
				opacity: 0.5,
				color: getColor(feature.properties.transit),
				weight:1.5,

			};
		},
		onEachFeature: onEachFeatureEdges
	}).addTo(map);



// nodes
	nodes = L.geoJSON([nodes], {

		onEachFeature: onEachFeatureNodes,

		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng, {
				radius:5,
				fillColor: getColor(feature.properties.transit),
				color: "black",
				weight: 1,
				opacity: 0.8,
				fillOpacity: 0.8
			});
		}

	}).addTo(map);



//timeline
function updateList(timeline){
        var displayed = timeline.getLayers();
				var current = document.getElementById('currentDate');
				current.innerHTML = "<br>";
				displayed.forEach(function(edge){
          current.innerHTML = moment((edge.feature.properties.date-25569)*86400*1000+4*5000000).format("YYYY-MM-DD");
        });

        var list = document.getElementById('displayed-list');
        list.innerHTML = "";
        displayed.forEach(function(edge){
          var li = document.createElement('li');
					var content = "<p>" +
							edge.feature.properties.from + "至"+ edge.feature.properties.to + edge.feature.properties.car_number;
          li.innerHTML = content;
          list.appendChild(li);
        });
      }

	function eqfeed_callback(data){
		var getInterval = function(edge) {
			// earthquake data only has a time, so we'll use that as a "start"
			// and the "end" will be that + some value based on magnitude
			// 18000000 = 30 minutes, so a quake of magnitude 5 would show on the
			// map for 150 minutes or 2.5 hours
			return {
				start: (edge.properties.date-25569)*86400*1000+4*5000000,
				end:  (edge.properties.date-25569)*86400*1000 + 30*3600000
			};
		};
		var timelineControl = L.timelineSliderControl({
			formatOutput: function(date){
				return moment(date).format("YYYY-MM-DD");
			},
			position:'bottomleft'
		});
		var timeline = L.timeline(data, {
			getInterval: getInterval,
			style:function style(feature) {
				return {
					opacity: 1,
					weight: 3,
					color: getColorAnimation(feature.properties.transit),
						};
			},
			onEachFeature: onEachFeatureEdges,
			className: "newEdge"
		});
		timelineControl.addTo(map);
		timelineControl.addTimelines(timeline);
		timeline.addTo(map);
		timeline.on('change', function(e){
			updateList(e.target);
		});
		updateList(timeline);
	}



</script>
<script src="data.geojsonp"></script>




</script>



</body>
</html>
